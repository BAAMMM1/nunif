# 色空間について

出力動画のYUVカラースペースとダイナミックレンジを指定します。

## 通常のSBS変換

| Colorspace  |                           |
|-------------|---------------------------|
| unspecified | 何もしません。過去のバージョンと同じ動作になります。
| auto     | 入力動画と同じカラースペース・ダイナミックレンジで出力します。
| bt709    | BT.709で出力します。ダイナミックレンジは入力動画と同じになります。
| bt709-pc | BT.709 フルレンジで出力します。
| bt709-tv | BT.709 リミテッドレンジで出力します。
| bt601\*  | bt709-\*のBT.601版です

### unspecifiedとそれ以外の違い

unspecifiedが指定された場合、動画がリミテッドレンジだった場合(ほとんどの動画はそうです)でもリミテッドレンジのままフルレンジ用のステレオ生成処理を実行します。
その結果として、色が変わったりバンディングが発生することがあります。

unspecified以外の場合は、フルレンジに変換してからステレオ生成処理を実行します。
出力がリミテッドレンジの場合は、エンコード時にフルレンジからリミテッドレンジに再変換します。
これはすべてがうまくいけば、unspecifiedよりも正しい処理になります。
しかし入力動画のカラースペースとダイナミックレンジが不明な場合や未知の値が指定されている場合に変換が正しくなかったりエラーになったりすることがあります。

### ピクセルフォーマットとの関係

ピクセルフォーマットにrgb24が指定されている場合は、色空間に何を指定していてもunspecifiedの動作になります。
ピクセルフォーマットにyuv420pまたはyuv444pが指定されていて、出力がフルレンジの場合はyuvj420pまたはyuvj444pが代わりに使用されます。

### 入力動画のカラースペースが不明な場合

720pより小さければBT.601、それ以外はBT.709とします。

### 入力動画のダイナミックレンジが不明な場合

ピクセルフォーマットから判定します。yuv4\*はリミテッドレンジ、yuvj4\*、rgb\*, grp\*はフルレンジと判定します。
どれでもないときは、未定義のままにします。

### 入力動画のカラースペースとダイナミックレンジが共に不明なままの場合

片方だけ不明な場合は予測値で変換します。
どちらも不明な場合はunspecifiedと同じ動作になります。

## エクスポート時

### unspecifiedが指定されている場合

ダイナミックレンジを変換せずにフレーム画像を出力します。

### unspecified以外が指定されている場合

フルレンジに変換したフレーム画像を出力します。動画がリミテッドレンジだった場合はフレーム画像上で色が変わります。インポート時にリミテッドレンジに変換すると最終動画の色は変わりません。

## インポート時

unspecified以外を指定してエクスポートした場合は、ymlファイルに`source_color_range`,`output_colorspace`が追加されています。
`source_color_range`が入力動画のダイナミックレンジ(1: MPEG Limited Range, 2: JPEG Full Range)、`output_colorspace`がフレーム画像のYUV時のカラースペース(1: BT.709, 5: BT.601)です。`source_color_range`は元動画のダイナミックレンジでありフレーム画像のダイナミックレンジではないことに注意してください。フレーム画像は常にフルレンジです。
この情報がインポート時にautoやカラースペース・ダイナミックレンジの変換で使用されます。

ymlファイルに`source_color_range`,`output_colorspace`存在しない場合は、フレーム画像は指定された色空間と同じと仮定して処理します。
bt709-tvが指定されている場合は、フレーム画像はBT.709 Limited Rangeのrgb24変換結果として扱われます。
bt709-pcが指定されている場合は、フレーム画像はBT.709 Full Rangeのrgb24変換結果として扱われます。

ymlファイルに`source_color_range`,`output_colorspace`存在しない原因は以下のいずれかです。

- 古いバージョンでエクスポートされている
- unspecifiedを指定してエクスポートされている
- 入力の動画のカラースペース・ダイナミックレンジが共に不明だった
